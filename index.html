<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Cathedral of Circuits · Integration Hub</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="color-scheme" content="light dark">
  <style>
    /* ND-safe palette: calm contrast, layered depth, no motion */
    :root {
      --bg-primary:#0b0c10;
      --bg-secondary:#1a1a2e;
      --ink-primary:#e6e6e6;
      --ink-secondary:#a9b1ba;
      --accent-gold:#d4af37;
      --border-color:#3a3a4a;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    html,body { min-height:100vh; background:var(--bg-primary); color:var(--ink-primary); font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    header { text-align:center; padding:3rem 1rem 2rem; border-bottom:1px solid var(--border-color); background:linear-gradient(135deg,var(--bg-primary),var(--bg-secondary)); }
    h1 { font-size:2.5rem; color:var(--accent-gold); text-shadow:0 0 20px rgba(212,175,55,0.3); letter-spacing:0.08em; margin-bottom:0.75rem; }
    .subtitle { color:var(--ink-secondary); font-size:0.95rem; }
    .status-bar { margin-top:1.5rem; display:flex; flex-wrap:wrap; justify-content:center; gap:1rem; color:var(--ink-secondary); font-size:0.85rem; }
    main { max-width:1440px; margin:0 auto; padding:2.5rem 1.5rem 4rem; display:flex; flex-direction:column; gap:2.5rem; }
    .constants-grid { display:flex; justify-content:space-around; flex-wrap:wrap; gap:2rem; padding:2rem; background:var(--bg-secondary); border-radius:10px; border:1px solid var(--border-color); }
    .constant-item { text-align:center; }
    .constant-number { display:block; font-size:2.1rem; font-weight:700; color:var(--accent-gold); }
    .constant-label { margin-top:0.35rem; color:var(--ink-secondary); font-size:0.85rem; text-transform:uppercase; letter-spacing:0.08em; }
    .section-title { font-size:1.5rem; color:var(--accent-gold); margin-bottom:1rem; text-transform:uppercase; letter-spacing:0.1em; }
    .note { color:var(--ink-secondary); max-width:960px; margin:0 auto; font-size:0.95rem; line-height:1.6; }
    .repo-section { display:flex; flex-direction:column; gap:1.2rem; }
    .repo-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:1.6rem; }
    .repo-card { background:var(--bg-secondary); border:1px solid var(--border-color); border-radius:10px; padding:1.6rem; display:flex; flex-direction:column; gap:0.75rem; position:relative; overflow:hidden; }
    .repo-card::before { content:""; position:absolute; top:0; left:0; right:0; height:3px; background:var(--accent-gold); transform:scaleX(0); transform-origin:left; transition:transform 0.3s ease; }
    .repo-card:hover::before { transform:scaleX(1); }
    .repo-title { font-size:1.3rem; color:var(--accent-gold); display:flex; align-items:center; gap:0.6rem; }
    .repo-role { color:var(--ink-secondary); font-size:0.9rem; font-style:italic; }
    .repo-features { list-style:none; display:flex; flex-direction:column; gap:0.4rem; color:var(--ink-secondary); font-size:0.95rem; }
    .repo-features li { position:relative; padding-left:1.3rem; }
    .repo-features li::before { content:"✦"; position:absolute; left:0; top:0; color:var(--accent-gold); }
    .repo-sublist { margin-top:0.35rem; list-style:none; padding-left:1.1rem; display:flex; flex-direction:column; gap:0.25rem; font-size:0.85rem; color:var(--ink-secondary); }
    .repo-sublist li::before { content:"–"; margin-right:0.35rem; color:var(--ink-secondary); }
    .repo-links { display:flex; gap:0.8rem; flex-wrap:wrap; }
    .repo-link { padding:0.45rem 1rem; border-radius:5px; border:1px solid var(--accent-gold); color:var(--accent-gold); text-decoration:none; font-size:0.9rem; transition:background 0.2s ease,color 0.2s ease; }
    .repo-link:hover, .repo-link:focus { background:var(--accent-gold); color:var(--bg-primary); }
    .status { display:inline-block; width:9px; height:9px; border-radius:50%; }
    .status.active { background:#4ade80; }
    .status.pending { background:#fbbf24; }
    .status.inactive { background:#ef4444; }
    .repo-fallback { text-align:center; color:var(--ink-secondary); font-size:0.9rem; }
    .renderer { display:flex; flex-direction:column; gap:1rem; align-items:center; }
    #stage { display:block; width:100%; max-width:1440px; height:auto; border:1px solid var(--border-color); box-shadow:0 0 0 1px rgba(0,0,0,0.3); }
    .instructions { background:var(--bg-secondary); border:1px solid var(--border-color); border-radius:10px; padding:2rem; display:flex; flex-direction:column; gap:1rem; }
    .instructions ol { padding-left:1.4rem; color:var(--ink-secondary); display:flex; flex-direction:column; gap:0.55rem; }
    code { background:#11111a; color:var(--accent-gold); padding:0.2rem 0.45rem; border-radius:4px; font-size:0.85rem; }
    footer { text-align:center; padding:3rem 1rem 4rem; border-top:1px solid var(--border-color); color:var(--accent-gold); font-style:italic; line-height:1.6; font-size:1.1rem; }
    @media (max-width:768px) {
      header { padding:2.5rem 1rem; }
      h1 { font-size:2.1rem; }
      .status-bar { flex-direction:column; align-items:center; }
      .constants-grid { padding:1.5rem; }
    }
    /* ND-safe: calm contrast, no motion, generous spacing */
    :root { --bg:#0b0b12; --ink:#e8e8f0; --muted:#a6a6c1; }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--ink); font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    header { padding:12px 16px; border-bottom:1px solid #1d1d2a; }
    .status { color:var(--muted); font-size:12px; }
    #stage { display:block; margin:16px auto; box-shadow:0 0 0 1px #1d1d2a; }
    .note { max-width:900px; margin:0 auto 16px; color:var(--muted); }
    code { background:#11111a; padding:2px 4px; border-radius:3px; }
  </style>
</head>
<body>
  <header>
    <h1>✦ Cathedral of Circuits ✦</h1>
    <p class="subtitle">ND-safe · Provenance required · Layered geometry · Offline-first bridge</p>
    <div class="status-bar" role="status" aria-live="polite">
      <span id="status">Loading palette…</span>
      <span id="manifest-status">Loading bridge manifest…</span>
    </div>
  </header>

  <main>
    <section class="constants-grid" aria-label="Sacred constants">
      <div class="constant-item"><span class="constant-number">0-144</span><span class="constant-label">All combinations</span></div>
      <div class="constant-item"><span class="constant-number">72</span><span class="constant-label">Angels</span></div>
      <div class="constant-item"><span class="constant-number">72</span><span class="constant-label">Demons</span></div>
      <div class="constant-item"><span class="constant-number">33</span><span class="constant-label">Spine chapters</span></div>
      <div class="constant-item"><span class="constant-number">78</span><span class="constant-label">Tarot arcana</span></div>
    </section>

    <section class="repo-section" aria-labelledby="integration-hub-title">
      <h2 id="integration-hub-title" class="section-title">Integration Hub</h2>
      <p class="note">Cards below assemble directly from <code>registry/notes/bridge_manifest.json</code>. This keeps provenance intact, prevents hardcoded lists, and preserves layered context for every realm.</p>
      <div id="repo-grid" class="repo-grid" aria-live="polite"></div>
      <p id="repo-fallback" class="repo-fallback">Bridge manifest loading…</p>
    </section>

    <section class="renderer" aria-labelledby="renderer-title">
      <h2 id="renderer-title" class="section-title">Cosmic Helix Renderer</h2>
      <canvas id="stage" width="1440" height="900" aria-label="Layered sacred geometry canvas"></canvas>
      <p class="note">Offline canvas renders Vesica field, Tree-of-Life scaffold, Fibonacci curve, and static double-helix lattice. No animation, no autoplay. If supporting data go missing, the renderer annotates the canvas with a calm notice while staying ND-safe.</p>
    </section>

    <section class="instructions" aria-labelledby="protocol-title">
      <h2 id="protocol-title" class="section-title">Deployment protocol</h2>
      <ol>
        <li>Clone each repository and align shared files from the blueprint archives.</li>
        <li>Place master images in <code>assets/raw/</code> (PNG/JPG only).</li>
        <li>Run <code>npm install</code> then <code>npm run build</code> for local confidence checks.</li>
        <li>Deploy manually to Netlify with <code>netlify deploy --prod --build</code> (no automated workflows).</li>
        <li>Disable image optimization in Netlify UI to keep layered geometry intact.</li>
        <li>Update <code>registry/realm_links.json</code> with live endpoints once verified.</li>
        <li>Confirm <code>/core/health-check.html</code> responds with 200 for each realm.</li>
        <li>Add new nodes or combinations to <code>registry/nodes.json</code> respecting schema and numerology counts.</li>
        <li>For content updates, bump <code>SW_VERSION</code> inside <code>public/sw.js</code> before shipping.</li>
      </ol>
    </section>
  </main>

  <footer>
    "In sacred pattern, healing is found. In open spiral, truth may be chosen. In the Codex, all is remembered."
  </footer>
    <div><strong>Cosmic Helix Renderer</strong> - layered sacred geometry (offline, ND-safe)</div>
    <div class="status" id="status">Loading palette...</div>
  </header>

  <canvas id="stage" width="1440" height="900" aria-label="Layered sacred geometry canvas"></canvas>
  <p class="note">This static renderer layers Vesica, Tree-of-Life, Fibonacci, and a static double-helix lattice. No animation, no autoplay, no external libs. Open this file directly.</p>

  <script type="module">
    import { renderHelix } from "./js/helix-renderer.mjs";

    const paletteStatus = document.getElementById("status");
    const manifestStatus = document.getElementById("manifest-status");
    const repoGrid = document.getElementById("repo-grid");
    const repoFallback = document.getElementById("repo-fallback");
    const canvas = document.getElementById("stage");
    const ctx = canvas.getContext("2d");

    const defaults = {
      palette: {
        bg:"#0b0b12",
        ink:"#e8e8f0",
        layers:["#b1c7ff","#89f7fe","#a0ffa1","#ffd27f","#f5a3ff","#d0d0e6"]
    const elStatus = document.getElementById("status");
    const canvas = document.getElementById("stage");
    const ctx = canvas.getContext("2d");
    const notices = [];

    async function loadJSON(path) {
      /*
        Offline covenant: skip fetch when opened via file:// so no network requests fire.
        When served over http(s) the fetch stays local and still honors the no-dependency rule.
      */
      if (typeof window === "undefined" || !window.fetch || (window.location && window.location.protocol === "file:")) {
        return null;
      }
    };

    const REPO_OVERRIDES = {
      "stone-cathedral": {
        title:"Stone Grimoire",
        site:"https://stone-grimoire.netlify.app",
        source:"https://github.com/yourusername/stone-grimoire"
      }
    };

    const STATUS_CLASS = new Map([
      ["source-of-truth","active"],
      ["active","active"],
      ["reference","active"],
      ["pending-merge","pending"],
      ["draft","pending"],
      ["inactive","inactive"]
    ]);

    const NUM = { THREE:3, SEVEN:7, NINE:9, ELEVEN:11, TWENTYTWO:22, THIRTYTHREE:33, NINETYNINE:99, ONEFORTYFOUR:144 };

    function mergePalette(defaultPalette, overridePalette, notices) {
      const base = { ...defaultPalette, layers:[...defaultPalette.layers] };
      if (!overridePalette || typeof overridePalette !== "object") {
        return base;
      }
      if (typeof overridePalette.bg === "string") {
        base.bg = overridePalette.bg;
      } else {
        notices.push("Palette missing bg; using default.");
      }
      if (typeof overridePalette.ink === "string") {
        base.ink = overridePalette.ink;
      } else {
        notices.push("Palette missing ink; using default.");
      }
      if (Array.isArray(overridePalette.layers)) {
        for (let i = 0; i < base.layers.length; i += 1) {
          if (typeof overridePalette.layers[i] === "string") {
            base.layers[i] = overridePalette.layers[i];
          } else if (overridePalette.layers[i] !== undefined) {
            notices.push("Palette layer " + (i + 1) + " invalid; using default.");
          }
        }
      } else {
        notices.push("Palette layers missing; using defaults.");
      }
      return base;
    }

    function formatTitle(repoId) {
      const override = REPO_OVERRIDES[repoId];
      if (override && override.title) {
        return override.title;
      }
      const pretty = repoId
        .replace(/-/g, " ")
        .replace(/([a-zA-Z])(\d)/g, "$1 $2");
      return pretty.split(" ").filter(Boolean).map((segment) => segment.charAt(0).toUpperCase() + segment.slice(1)).join(" ");
    }

    function resolveLink(repoId, type) {
      const override = REPO_OVERRIDES[repoId];
      if (override && override[type]) {
        return override[type];
      }
      if (type === "site") {
        return "https://" + repoId + ".netlify.app";
      }
      return "https://github.com/yourusername/" + repoId;
    }

    function statusClass(status) {
      return STATUS_CLASS.get(status) || "pending";
    }

    function formatList(values) {
      if (!Array.isArray(values) || values.length === 0) {
        return "None recorded";
      }
      return values.join(", ");
    }

    function createNextActionsList(nextActions) {
      const sublist = document.createElement("ul");
      sublist.className = "repo-sublist";
      nextActions.forEach((action) => {
        const item = document.createElement("li");
        item.textContent = action;
        sublist.appendChild(item);
      });
      return sublist;
    }

    function createRepoCard(repo) {
      const card = document.createElement("article");
      card.className = "repo-card";

      const title = document.createElement("h3");
      title.className = "repo-title";
      title.textContent = formatTitle(repo.id);
      const statusDot = document.createElement("span");
      statusDot.className = "status " + statusClass(repo.status);
      statusDot.title = repo.status;
      title.appendChild(statusDot);

      const role = document.createElement("p");
      role.className = "repo-role";
      role.textContent = repo.role || "Role undocumented";

      const features = document.createElement("ul");
      features.className = "repo-features";
      const linkedIds = document.createElement("li");
      linkedIds.textContent = "Linked IDs: " + formatList(repo.linked_ids);
      features.appendChild(linkedIds);

      if (Array.isArray(repo.bridges) && repo.bridges.length > 0) {
        repo.bridges.forEach((bridge) => {
          const focus = Array.isArray(bridge.focus) ? bridge.focus.join(", ") : "Focus pending";
          const bridgeItem = document.createElement("li");
          bridgeItem.textContent = "Bridge → " + formatTitle(bridge.id) + ": " + focus;
          if (Array.isArray(bridge.next_actions) && bridge.next_actions.length > 0) {
            bridgeItem.appendChild(createNextActionsList(bridge.next_actions));
          }
          features.appendChild(bridgeItem);
        });
      }

      if (repo.notes) {
        const noteItem = document.createElement("li");
        noteItem.textContent = repo.notes;
        features.appendChild(noteItem);
      }

      const linksContainer = document.createElement("div");
      linksContainer.className = "repo-links";
      const siteLink = document.createElement("a");
      siteLink.className = "repo-link";
      siteLink.href = resolveLink(repo.id, "site");
      siteLink.target = "_blank";
      siteLink.rel = "noopener noreferrer";
      siteLink.textContent = "Visit site";
      linksContainer.appendChild(siteLink);

      const repoLink = document.createElement("a");
      repoLink.className = "repo-link";
      repoLink.href = resolveLink(repo.id, "source");
      repoLink.target = "_blank";
      repoLink.rel = "noopener noreferrer";
      repoLink.textContent = "GitHub";
      linksContainer.appendChild(repoLink);

      card.appendChild(title);
      card.appendChild(role);
      card.appendChild(features);
      card.appendChild(linksContainer);
      return card;
    }

    function populateRepoGrid(repos) {
      repoGrid.innerHTML = "";
      if (!Array.isArray(repos) || repos.length === 0) {
        repoFallback.textContent = "Bridge manifest contained no repos; add entries to registry/notes/bridge_manifest.json.";
        return;
      }
      repos.forEach((repo) => {
        repoGrid.appendChild(createRepoCard(repo));
      });
      repoFallback.textContent = "";
    }

    async function loadPalette() {
      const notices = [];
      try {
        const module = await import("./data/palette.json", { assert:{ type:"json" } });
        if (paletteStatus) {
          paletteStatus.textContent = "Palette loaded.";
        }
        return { palette: module.default, notices };
      } catch (error) {
        notices.push("Palette JSON not available; calm defaults engaged.");
        if (paletteStatus) {
          paletteStatus.textContent = "Palette missing; using safe fallback.";
        }
        return { palette: null, notices };
      }
    }

    async function loadManifest() {
      try {
        const module = await import("./registry/notes/bridge_manifest.json", { assert:{ type:"json" } });
        const manifest = module.default;
        if (manifestStatus) {
          const stamp = manifest.last_updated ? "Last updated " + manifest.last_updated : "Bridge manifest loaded.";
          manifestStatus.textContent = stamp;
        }
        populateRepoGrid(manifest.repos);
        return [];
      } catch (error) {
        const message = "Bridge manifest missing; hub cards in fallback mode.";
        if (manifestStatus) {
          manifestStatus.textContent = message;
        }
        repoFallback.textContent = message + " Update registry/notes/bridge_manifest.json to restore details.";
        return [message];
      }
    }

    async function main() {
      const notices = [];
      const paletteResult = await loadPalette();
      const palette = mergePalette(defaults.palette, paletteResult.palette, paletteResult.notices);
      notices.push(...paletteResult.notices);
      const manifestNotices = await loadManifest();
      notices.push(...manifestNotices);

      if (!ctx) {
        if (paletteStatus) {
          paletteStatus.textContent = "2D canvas context unavailable.";
        }
        return;
      }

      renderHelix(ctx, { width:canvas.width, height:canvas.height, palette, NUM, notices });
    }

    main();
    if (!ctx) {
      if (elStatus) elStatus.textContent = "2D canvas context unavailable.";
      notices.push("Canvas context unavailable; nothing rendered.");
    } else {
      // Numerology constants used by geometry routines
      const NUM = { THREE:3, SEVEN:7, NINE:9, ELEVEN:11, TWENTYTWO:22, THIRTYTHREE:33, NINETYNINE:99, ONEFORTYFOUR:144 };

      // ND-safe rationale: no motion, high readability, soft colors, layered order
      renderHelix(ctx, { width:canvas.width, height:canvas.height, palette:active, NUM, notices:[...notices, ...paletteNotices] });
    }
  </script>
</body>
</html>
